# withings connector
## About Withings
[Withings](http://www2.withings.com/) is a company that designs and sells fitness and health trackers, monitors and analyzers.
The device's data and services are exposed to developers as REST APIs.
## Purpose of the scriptr.io connector for carvoyant
The purpose of this connector is to simplify and streamline the way you access withings' APIs from scriptr.io, by providing you with a few native objects that you can directly integrate into your own scripts. 
This will hopefully allow you to create sophisticated health and fitness oriented applications. 
## Components
- withings/user: this is the main object to interact with. It provides access to the data that is generated by the devices of a given user (the one for who you are passing an access token)
- withings/notifications: manages subscriptions to any type of withings notifications. 
- withings/common: configuration file that contains parameters used by the notifications script.
- withings/mappings: configuration file used for internal purposes (constants and descriptions).
- withings/withingsClient: generic http client that handles the communication between scriptr.io and withings' APIs. Used by user and notifications.
- withings/api/handleEvent: default callback invoked by withings when sending notifications.
- withings/notificationHandlers/DefaultHandler: this is the default handler that is triggered upon the occurrence of any
withings event. You can define your own handlers and map them to event using the "withings/common" script. 
- withings/authorization/getRequestTokenUrl: This script implements steps 1 and 2 of the Withings OAuth authorization process.
- withings/authorization/getAccessToken: This script implements step 3 of the Withings OAuth authorization process.
- withings/test/tests: a list of examples on how to use the connectors' objects and corresponding methods.
- withings/lib: this folder contains utility scripts that are used by the OAuth authorization process.

## How to use
- Deploy the aforementioned scripts in your scriptr account, in a folder named "withings".
- Create a developer account and an application at [withings](http://www2.withings.com/us/en/developers).
- Once done, make sure to copy/paste the values of your API key and API secret in the corresponding
variables of the "config" file (respectively client_id and client_secret).
- Create an end user account (https://account.withings.com/)  
- Create a test script in scriptr, or use the script provided in carvoyant/test/. 

### Obtain access tokens from carvoyant

#### Step 1
From a front-end application, send a request to the ```/authorization/getRequestTokenUrl``` script.
The result returned by the aforementioned script should resemble the following:

```
>> curl -X POST  -F username=edison -F apsws.time=1434722158021 -H 'Authorization: bearer <YOUR_AUTH_TOKEN>' 'https://api.scriptr.io/oauth2/getRequestCodeUrl'
{
	"metadata": {
		"requestId": "45753a7f-a2b6-4378-a8e1-3bbddced9694",
		"status": "success",
		"statusCode": "200"
	},
	"result": "https://sandbox-auth.carvoyant.com/OAuth/authorize?client_id=atkchwp98j3whpg6cjgwt98h&response_type=token&state=02a0e4&redirect_uri=https%3A%2F%2Fapi.scriptr.io%2Foauth2%2FgetAccessToken%3Fauth_token%3SKzM1RnYwAzc4Mg%3D%3D%26state%3R02a1e4""
}
```
#### Step 2

From the front-end, issue a request to the obtained URL. This redirects your end user to the withings login and authorization page, 
where he has to enter his credentials then authorize the application on the requested scope. 
Once this is done, withings automatically calls back the ```authorization/getAccessToken``` script, providing it with access and secret tokens.
 These ared stored in your scriptr.io's global storage.

### Use the connector

In order to use the connector, you need to import the main module: ```withings/user```, as described below:
```
var userModule = require("withings/user");
```
Then create a new instance of the User class, defined in this module (we assume that we already otbained an access token for the given user):
```
var user = new userModule.User({userid:"123456"});
```
The User class provides many methods to obtain data related to devices pertaining to the end user, such as:
```

// list all user's activities starting from the given date
user.listActivities({from: "2015-07-21"}); 

// list the user's sleep measures for the given time framne
user.listSleepMeasures({from: new Date("2015-07-21"), to:new Date("2015-08-24")});

// subscribe to notifications 
var common = require("withings/common");
var sub = {
  "notificationType": common.notificationTypes.WEIGHT
};

var notificationManager = user.getNotificationManager();
notificationManager.subscribeToNotification(sub); 
```

*You can check the list of all available methods using the ```withings/test/tests``` script.*

### About notifications
As mentioned, you can subscribe to notifications that are emitted by a given device for the concerned user.
By default, withings is instructed by the connector to send notifications to the https://api.scriptr.io/withings/api/handleNotifications API 
that resides in your account. This API's job is to trigger the handler that is configured to process the corresponding notification type.
By default, the "/withings/notifications/DefaultHandler" is invoked for all the notification types. You can implement your own handlers 
and configure what handler to use for what notification type in the "/withings/common" script.
